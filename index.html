<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æŒ‡åŒ—é‡åœ°åœ–æ‡‰ç”¨</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotate@0.1.4/dist/leaflet-rotate-src.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
      body, html {
          height: 100%;
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
      }
      
      #map {
          height: 100%;
          width: 100%;
      }
      
      /* æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
      #controls {
          position: absolute;
          bottom: 30px;
          right: 20px;
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      
      .control-btn {
          display: flex;
          justify-content: center;
          align-items: center;
          width: 60px;
          height: 60px;
          background-color: white;
          border: 2px solid #ccc;
          border-radius: 50%;
          cursor: pointer;
          font-size: 24px;
          color: #333;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      
      .control-btn:hover {
          background-color: #f0f0f0;
          transform: scale(1.1);
      }
      
      .control-btn.active {
          background-color: #007bff;
          color: white;
          border-color: #007bff;
          animation: pulse 2s infinite;
      }
      
      /* å®šä½æŒ‰éˆ•æ¨£å¼ */
      #locateBtn {
          position: absolute;
          bottom: 110px;
          right: 20px;
          z-index: 1000;
      }
      
      #locateBtn.active {
          background-color: #28a745;
          color: white;
          border-color: #28a745;
      }
      
      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 600px) {
          #controls {
              bottom: 20px;
              right: 10px;
          }
          
          #locateBtn {
              bottom: 90px;
              right: 10px;
          }
          
          .control-btn {
              width: 50px;
              height: 50px;
              font-size: 20px;
          }
      }
      
      /* è„ˆè¡å‹•ç•« */
      @keyframes pulse {
          0% {
              box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
          }
          70% {
              box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
          }
          100% {
              box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
          }
      }
      
      /* ç”¨æˆ¶ä½ç½®æ¨™è¨˜å‹•ç•« */
      @keyframes locationPulse {
          0% {
              transform: scale(1);
              opacity: 1;
          }
          50% {
              transform: scale(1.2);
              opacity: 0.7;
          }
          100% {
              transform: scale(1);
              opacity: 1;
          }
      }
      
      .user-location-marker {
          animation: locationPulse 2s infinite;
      }
      
      /* è¼‰å…¥æç¤º */
      .loading-overlay {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 2000;
          display: none;
      }
      
      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #007bff;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
          margin: 0 auto 10px;
      }
      
      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- è¼‰å…¥æç¤º -->
  <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <div>æ­£åœ¨ç²å–ä½ç½®...</div>
  </div>
  
  <!-- å®šä½æŒ‰éˆ• -->
  <button id="locateBtn" class="control-btn" title="å®šä½">
      <i class="fas fa-crosshairs"></i>
  </button>
  
  <!-- æ§åˆ¶æŒ‰éˆ• -->
  <div id="controls">
      <button id="toggleCompass" class="control-btn" title="æŒ‡åŒ—é‡æ¨¡å¼">
          <i class="fas fa-compass"></i>
      </button>
      <button id="resetRotation" class="control-btn" title="é‡ç½®æ–¹å‘">
          <i class="fas fa-undo"></i>
      </button>
  </div>

  <script>
      let map;
      let toggleButton = document.getElementById('toggleCompass');
      let resetButton = document.getElementById('resetRotation');
      let locateButton = document.getElementById('locateBtn');
      let loadingOverlay = document.getElementById('loadingOverlay');
      
      let isCompassActive = false;
      let isLocationActive = false;
      let lastHeading = null;
      let watchId = null;
      let userLocationMarker = null;
      let locationWatchId = null;

      // åˆå§‹åŒ–åœ°åœ–
      function initMap() {
          map = L.map('map', {
              center: [25.0330, 121.5654], // å°åŒ—101
              zoom: 16,
              maxZoom: 22,
              rotate: true, // å•Ÿç”¨æ—‹è½‰åŠŸèƒ½
              rotateControl: {
                  closeOnZeroBearing: false
              }
          });

          // æ·»åŠ åœ°åœ–åœ–å±¤
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              maxZoom: 22
          }).addTo(map);

          // æ·»åŠ ä¸€å€‹ç¤ºç¯„æ¨™è¨˜
          L.marker([25.0330, 121.5654])
              .addTo(map)
              .bindPopup('å°åŒ—101<br>é»æ“Šå®šä½æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®ï¼')
              .openPopup();
      }

      // è™•ç†è¨­å‚™æ–¹å‘è®ŠåŒ–
      function handleOrientation(event) {
          if (!isCompassActive) return;
          
          // ç²å–æ–¹ä½è§’ (alphaå€¼)
          let alpha = event.webkitCompassHeading || event.alpha;
          
          if (alpha !== null) {
              // å°‡ alpha å€¼è½‰æ›ç‚ºä»¥æ­£åŒ—ç‚º 0 åº¦çš„æ–¹ä½è§’
              let heading = alpha;
              if (event.alpha !== undefined) {
                  heading = 360 - alpha; // å°æ–¼ä½¿ç”¨ alpha çš„è¨­å‚™ï¼Œéœ€è¦åè½‰æ–¹å‘
              }
              
              // åªæœ‰æ–¹å‘è®ŠåŒ–è¶…é1åº¦æ‰æ›´æ–°åœ°åœ–ï¼Œé¿å…éåº¦æ›´æ–°
              if (lastHeading === null || Math.abs(heading - lastHeading) > 1) {
                  rotateMap(heading);
                  lastHeading = heading;
              }
          }
      }

      // æ—‹è½‰åœ°åœ–
      function rotateMap(heading) {
          // è¨­ç½®åœ°åœ–æ–¹ä½è§’ (å¹³æ»‘æ—‹è½‰)
          map.setBearing(heading);
      }

      // åˆ‡æ›æŒ‡åŒ—é‡åŠŸèƒ½
      function toggleCompass() {
          isCompassActive = !isCompassActive;
          
          if (isCompassActive) {
              startCompass();
          } else {
              stopCompass();
          }
      }

      // å•Ÿå‹•æŒ‡åŒ—é‡
      function startCompass() {
          toggleButton.classList.add('active');
          
          // æª¢æŸ¥è¨­å‚™æ˜¯å¦æ”¯æ´æ–¹å‘æ„Ÿæ¸¬
          if (window.DeviceOrientationEvent) {
              // iOS 13+ éœ€è¦è«‹æ±‚æ¬Šé™
              if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                  DeviceOrientationEvent.requestPermission()
                      .then(response => {
                          if (response === 'granted') {
                              window.addEventListener("deviceorientation", handleOrientation, true);
                              console.log('æŒ‡åŒ—é‡å·²å•Ÿå‹•');
                          } else {
                              alert('éœ€è¦æ–¹å‘æ„Ÿæ¸¬æ¬Šé™æ‰èƒ½ä½¿ç”¨æŒ‡åŒ—é‡åŠŸèƒ½');
                              stopCompass();
                          }
                      })
                      .catch(error => {
                          console.error('æ¬Šé™è«‹æ±‚å¤±æ•—:', error);
                          alert('ç„¡æ³•å•Ÿå‹•æŒ‡åŒ—é‡åŠŸèƒ½');
                          stopCompass();
                      });
              } else {
                  // é iOS è¨­å‚™æˆ–è¼ƒèˆŠç‰ˆæœ¬
                  window.addEventListener("deviceorientation", handleOrientation, true);
                  console.log('æŒ‡åŒ—é‡å·²å•Ÿå‹•');
              }
          } else {
              alert('æ‚¨çš„è¨­å‚™ä¸æ”¯æ´æ–¹å‘æ„Ÿæ¸¬åŠŸèƒ½');
              stopCompass();
          }
      }

      // åœæ­¢æŒ‡åŒ—é‡
      function stopCompass() {
          isCompassActive = false;
          toggleButton.classList.remove('active');
          
          // ç§»é™¤äº‹ä»¶ç›£è½å™¨
          window.removeEventListener("deviceorientation", handleOrientation, true);
          
          // é‡ç½®åœ°åœ–æ–¹å‘
          rotateMap(0);
          lastHeading = null;
          
          console.log('æŒ‡åŒ—é‡å·²é—œé–‰ï¼Œåœ°åœ–æ–¹å‘å·²é‡ç½®');
      }

      // é‡ç½®åœ°åœ–æ–¹å‘
      function resetRotation() {
          rotateMap(0);
          lastHeading = null;
          console.log('åœ°åœ–æ–¹å‘å·²é‡ç½®');
      }

      // åˆ‡æ›å®šä½åŠŸèƒ½
      function toggleLocation() {
          isLocationActive = !isLocationActive;
          
          if (isLocationActive) {
              startLocation();
          } else {
              stopLocation();
          }
      }

      // é–‹å§‹å®šä½
      function startLocation() {
          if (!navigator.geolocation) {
              alert('æ‚¨çš„è¨­å‚™ä¸æ”¯æ´å®šä½åŠŸèƒ½');
              return;
          }

          locateButton.classList.add('active');
          loadingOverlay.style.display = 'block';

          // å…ˆç²å–ä¸€æ¬¡ç•¶å‰ä½ç½®
          navigator.geolocation.getCurrentPosition(
              function(position) {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;
                  const accuracy = position.coords.accuracy;
                  
                  updateUserLocation(lat, lng, accuracy);
                  loadingOverlay.style.display = 'none';
                  
                  // é–‹å§‹æŒçºŒç›£æ§ä½ç½®
                  startLocationWatch();
              },
              function(error) {
                  loadingOverlay.style.display = 'none';
                  handleLocationError(error);
              },
              {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 60000
              }
          );
      }

      // é–‹å§‹æŒçºŒå®šä½ç›£æ§
      function startLocationWatch() {
          locationWatchId = navigator.geolocation.watchPosition(
              function(position) {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;
                  const accuracy = position.coords.accuracy;
                  
                  updateUserLocation(lat, lng, accuracy);
              },
              function(error) {
                  console.error('å®šä½ç›£æ§éŒ¯èª¤:', error);
              },
              {
                  enableHighAccuracy: true,
                  maximumAge: 30000,
                  timeout: 15000
              }
          );
      }

      // æ›´æ–°ç”¨æˆ¶ä½ç½®
      function updateUserLocation(lat, lng, accuracy) {
          // å‰µå»ºæˆ–æ›´æ–°ä½ç½®æ¨™è¨˜
          if (!userLocationMarker) {
              userLocationMarker = L.marker([lat, lng], {
                  icon: L.divIcon({
                      className: 'user-location-marker',
                      html: `
                          <div style="
                              background-color: #007bff; 
                              width: 16px; 
                              height: 16px; 
                              border-radius: 50%; 
                              border: 3px solid white; 
                              box-shadow: 0 0 10px rgba(0,123,255,0.5);
                              position: relative;
                          ">
                              <div style="
                                  position: absolute;
                                  top: -50%;
                                  left: -50%;
                                  width: 200%;
                                  height: 200%;
                                  border: 2px solid #007bff;
                                  border-radius: 50%;
                                  opacity: 0.3;
                              "></div>
                          </div>
                      `,
                      iconSize: [22, 22],
                      iconAnchor: [11, 11]
                  })
              }).addTo(map);
              
              // ç§»å‹•åœ°åœ–åˆ°ç”¨æˆ¶ä½ç½®
              map.setView([lat, lng], 18);
              
              // æ·»åŠ ç²¾åº¦åœ“åœˆ
              if (accuracy < 100) {
                  L.circle([lat, lng], {
                      radius: accuracy,
                      color: '#007bff',
                      fillColor: '#007bff',
                      fillOpacity: 0.1,
                      weight: 1
                  }).addTo(map);
              }
              
          } else {
              // æ›´æ–°ç¾æœ‰æ¨™è¨˜ä½ç½®
              userLocationMarker.setLatLng([lat, lng]);
          }
          
          // ç¶å®šå½ˆå‡ºè¦–çª—
          userLocationMarker.bindPopup(`
              <div style="text-align: center;">
                  <strong>æ‚¨çš„ä½ç½®</strong><br>
                  ç·¯åº¦: ${lat.toFixed(6)}<br>
                  ç¶“åº¦: ${lng.toFixed(6)}<br>
                  ç²¾åº¦: ${Math.round(accuracy)}å…¬å°º
              </div>
          `);
      }

      // åœæ­¢å®šä½
      function stopLocation() {
          isLocationActive = false;
          locateButton.classList.remove('active');
          
          // åœæ­¢ä½ç½®ç›£æ§
          if (locationWatchId) {
              navigator.geolocation.clearWatch(locationWatchId);
              locationWatchId = null;
          }
          
          // ç§»é™¤ä½ç½®æ¨™è¨˜
          if (userLocationMarker) {
              map.removeLayer(userLocationMarker);
              userLocationMarker = null;
          }
          
          console.log('å®šä½å·²é—œé–‰');
      }

      // è™•ç†å®šä½éŒ¯èª¤
      function handleLocationError(error) {
          let message = '';
          switch(error.code) {
              case error.PERMISSION_DENIED:
                  message = "å®šä½æ¬Šé™è¢«æ‹’çµ•";
                  break;
              case error.POSITION_UNAVAILABLE:
                  message = "ç„¡æ³•ç²å–ä½ç½®è³‡è¨Š";
                  break;
              case error.TIMEOUT:
                  message = "å®šä½è«‹æ±‚è¶…æ™‚";
                  break;
              default:
                  message = "ç²å–ä½ç½®æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";
                  break;
          }
          alert(message);
          stopLocation();
      }

      // ç¶å®šäº‹ä»¶ç›£è½å™¨
      toggleButton.addEventListener('click', toggleCompass);
      resetButton.addEventListener('click', resetRotation);
      locateButton.addEventListener('click', toggleLocation);

      // åˆå§‹åŒ–åœ°åœ–
      initMap();

      // è™•ç†é é¢å¯è¦‹æ€§è®ŠåŒ–
      document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
              // é é¢éš±è—æ™‚æš«åœåŠŸèƒ½
              if (isCompassActive) {
                  window.removeEventListener("deviceorientation", handleOrientation, true);
              }
          } else if (!document.hidden) {
              // é é¢é¡¯ç¤ºæ™‚æ¢å¾©åŠŸèƒ½
              if (isCompassActive) {
                  window.addEventListener("deviceorientation", handleOrientation, true);
              }
          }
      });

      // è™•ç†çª—å£å¤§å°è®ŠåŒ–
      window.addEventListener('resize', function() {
          map.invalidateSize();
      });

      // æ·»åŠ è§¸æ§æ‰‹å‹¢æ”¯æ´ (é˜²æ­¢åœ°åœ–æ‹–æ‹½æ™‚è§¸ç™¼æŒ‡åŒ—é‡)
      let isDragging = false;
      
      map.on('dragstart', function() {
          isDragging = true;
      });
      
      map.on('dragend', function() {
          setTimeout(() => {
              isDragging = false;
          }, 100);
      });

      console.log('æŒ‡åŒ—é‡åœ°åœ–æ‡‰ç”¨å·²è¼‰å…¥å®Œæˆï¼');
      console.log('ğŸ§­ é»æ“ŠæŒ‡åŒ—é‡æŒ‰éˆ•å•Ÿå‹•åœ°åœ–æ—‹è½‰åŠŸèƒ½');
      console.log('ğŸ“ é»æ“Šå®šä½æŒ‰éˆ•ç²å–æ‚¨çš„ä½ç½®');
  </script>
</body>
</html>
